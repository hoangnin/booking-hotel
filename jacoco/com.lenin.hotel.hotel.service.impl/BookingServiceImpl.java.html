<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BookingServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hotel</a> &gt; <a href="index.source.html" class="el_package">com.lenin.hotel.hotel.service.impl</a> &gt; <span class="el_source">BookingServiceImpl.java</span></div><h1>BookingServiceImpl.java</h1><pre class="source lang-java linenums">package com.lenin.hotel.hotel.service.impl;

import com.lenin.hotel.authentication.model.User;
import com.lenin.hotel.authentication.repository.UserRepository;
import com.lenin.hotel.hotel.model.Booking;
import com.lenin.hotel.common.PagedResponse;
import com.lenin.hotel.common.exception.BusinessException;
import com.lenin.hotel.common.service.IEmailService;
import com.lenin.hotel.common.exception.ResourceNotFoundException;
import com.lenin.hotel.hotel.model.Hotel;
import com.lenin.hotel.hotel.model.PriceTracking;
import com.lenin.hotel.hotel.repository.BookingRepository;
import com.lenin.hotel.hotel.repository.HotelRepository;
import com.lenin.hotel.hotel.dto.request.BookingRequest;
import com.lenin.hotel.hotel.dto.response.BookingResponse;
import com.lenin.hotel.hotel.service.IBookingService;
import com.lenin.hotel.hotel.service.IHotelService;
import com.lenin.hotel.hotel.utils.BookingUtils;
import com.lenin.hotel.payment.service.IPaymentService;
import com.lenin.hotel.payment.service.impl.PaymentServiceImpl;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;

import static com.lenin.hotel.common.utils.SecurityUtils.getCurrentUsername;
import static com.lenin.hotel.hotel.utils.BookingUtils.buildBookingEntity;
import static com.lenin.hotel.hotel.utils.BookingUtils.buildBookingResponse;

@Service
@Transactional
@RequiredArgsConstructor
public class BookingServiceImpl implements IBookingService {
    private final BookingRepository bookingRepository;
    private final UserRepository userRepository;
    private final HotelRepository hotelRepository;
    private final IHotelService hotelService;
    private final IEmailService IEmailService;
    private final IPaymentService checkoutService;
    private final PaymentServiceImpl paymentServiceImpl;

    @Override
    public BookingResponse createBooking(BookingRequest bookingRequest) {
<span class="fc" id="L47">        Booking booking = buildBookingEntity(bookingRequest);</span>
<span class="fc" id="L48">        User user = userRepository.getByUsername(getCurrentUsername()).orElseThrow(() -&gt;new RuntimeException(&quot;User not found&quot;));</span>
<span class="fc" id="L49">        booking.setUser(user);</span>
<span class="pc" id="L50">        Hotel hotel  = hotelRepository.findById(bookingRequest.getHotelId()).orElseThrow(() -&gt; new RuntimeException(&quot;Hotel not found&quot;));</span>
<span class="fc" id="L51">        booking.setHotel(hotel);</span>
<span class="fc" id="L52">        PriceTracking priceTracking = hotelService.getLatestPrice(Long.valueOf(bookingRequest.getHotelId()));</span>
<span class="pc bpc" id="L53" title="1 of 2 branches missed.">        if (priceTracking == null) {</span>
<span class="nc" id="L54">            throw new ResourceNotFoundException(&quot;Hotel not found&quot;);</span>
        }
<span class="fc" id="L56">        booking.setPriceTracking(priceTracking);</span>
<span class="fc" id="L57">        boolean isOverlapping = bookingRepository.existsOverlappingBooking(</span>
<span class="fc" id="L58">                bookingRequest.getHotelId(), bookingRequest.getCheckIn(), bookingRequest.getCheckOut()</span>
        );

<span class="fc bfc" id="L61" title="All 2 branches covered.">        if (isOverlapping) {</span>
<span class="fc" id="L62">            throw new IllegalStateException(&quot;The selected dates are already booked.&quot;);</span>
        }
<span class="fc" id="L64">        bookingRepository.save(booking);</span>

<span class="fc" id="L66">        IEmailService.sendMailBookingSuccess(booking);</span>
<span class="fc" id="L67">        BookingResponse bookingResponse = buildBookingResponse(booking);</span>

        //create payment url
<span class="fc" id="L70">        String paymentUrl = paymentServiceImpl.createPayment(booking);</span>
<span class="fc" id="L71">        bookingResponse.setPaymentUrl(paymentUrl);</span>
<span class="fc" id="L72">        return bookingResponse;</span>
    }

    @Override
    public PagedResponse&lt;BookingResponse&gt; getBookingByUser(int page, int size) {
<span class="pc" id="L77">        User user = userRepository.getByUsername(getCurrentUsername()).orElseThrow(() -&gt; new BusinessException(&quot;User not found&quot;));</span>
<span class="fc" id="L78">        Pageable pageable = PageRequest.of(page, size, Sort.by(Sort.Direction.DESC, &quot;createDt&quot;));</span>
<span class="fc" id="L79">        Page&lt;Booking&gt; bookingPage = bookingRepository.findAllByUser(user, pageable);</span>
<span class="fc" id="L80">        return new PagedResponse&lt;&gt;(</span>
<span class="fc" id="L81">                bookingPage.getContent().stream().map(BookingUtils::buildBookingResponse).toList(),</span>
<span class="fc" id="L82">                bookingPage.getNumber(),</span>
<span class="fc" id="L83">                bookingPage.getSize(),</span>
<span class="fc" id="L84">                bookingPage.getTotalElements(),</span>
<span class="fc" id="L85">                bookingPage.getTotalPages(),</span>
<span class="fc" id="L86">                bookingPage.isLast()</span>
        );
    }

    @Override
    public BookingResponse getBookingById(Integer id) {
<span class="nc" id="L92">        Booking booking = bookingRepository.findById(id).orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Booking not found&quot;));</span>
<span class="nc" id="L93">        return buildBookingResponse(booking);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>